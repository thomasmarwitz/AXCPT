<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXCPT Mockup</title>
    <script src="jspsych-6.2.0/jspsych.js"></script>
    <!-- CSS -->
    <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
    <!-- PLugins -->
    <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.2.0/plugins/jspsych-instructions.js"></script>
    <!--Include jQuery library-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--load custom helper scripts-->
    <script src="helper.js"></script>
    <script src="csv-formatter.js"></script> <!--JSON2CSV-->
    <!--CSS-->
    <link href="styles.css" rel="stylesheet" type="text/css">

</head>
<body id="experiment-body"></body>
<script>

    const AMOUNT_TRIALS = 10 // Cue + Probe is ONE trial
    const ALPHABET = [...'ABCDEFGHIJKLMNOPQRSTUVWXYZ']
    const PHP_SCRIPT_FILE = 'write_data.php' // SAVING DATA PHP-SCRIPT
    const CUE = "A"
    const TARGET_KEY = "f"
    const PROBE = "X"
    const NON_TARGET_KEY = "j"
    const EXCLUDED_CUE = [CUE, PROBE, "K", "Y"]
    const EXCLUDED_PROBE = [CUE, PROBE, "K", "Y"] // alles, auÃŸer Y und K, A und X
    const NON_CUE = ALPHABET.filter((c) => !EXCLUDED_CUE.includes(c)) 
    const NON_PROBE = ALPHABET.filter((c) => !EXCLUDED_PROBE.includes(c)) 
    const SHORT_CONDITION_TIME = 1000
    const LONG_CONDITION_TIME = 5000
    const MAX_ANSWER_TIME = 1500
    const STIMULUS_PRESENTATION_TIME = 500
    const DISTRACTION_INTERFERENCE = false
    const DELAY = SHORT_CONDITION_TIME // in seconds, long delay: 5(!)-10s
    const CUE_PROBE_FONTSIZE = "60px"
    const PENALITY_FONTSIZE = "60px"
    const VISUAL_FEEDBACK_COLOR = "#BFBFBF"
    const BACKGROUND_COLOR = "#686868"

    const INTERTRIAL_DELAY = DELAY == SHORT_CONDITION_TIME ? LONG_CONDITION_TIME : SHORT_CONDITION_TIME // varies inversly

    function getRandomElement(array) {
        return jsPsych.randomization.sampleWithoutReplacement(array, 1)[0]
    }

    function changeBackgroundColor(colorString) {
        $("#jspsych-target").css("background-color", colorString)
        $("#experiment-body").css("background-color", colorString)
    }

    function generateTrialList(n) {
        const AMOUNT_TARGET = n * 0.7               // AX
        const AMOUNT_NON_CUE_PROBE = n * 0.1        // BX
        const AMOUNT_CUE_NON_PROBE = n * 0.1        // AY
        const AMOUNT_NON_CUE_NON_PROBE = n * 0.1    // BY

        const STANDARD_ARRAY = jsPsych.randomization.repeat(
            ["AX", "BX", "AY", "BY"], 
            [AMOUNT_TARGET, AMOUNT_NON_CUE_PROBE, AMOUNT_NON_CUE_PROBE, AMOUNT_NON_CUE_NON_PROBE], 
            false) // generate the conditions with standard values

        return STANDARD_ARRAY.map((condition) => {
            const RANDOM_NON_CUE =      getRandomElement(NON_CUE)
            const RANDOM_NON_PROBE =    getRandomElement(NON_PROBE)
            
            return ( // turn standard array with mapping into destandardized array (random non cues/probes)
                condition
                .replace("B", RANDOM_NON_CUE)
                .replace("Y", RANDOM_NON_PROBE)
            )
        })
    }

    function generateTimelineVariables(n) {
        if (n % 10 != 0) {
            console.log("Warning, not a multiple of ten")
            n += 10 - (n % 10) // fill up to ten
        }
        const TRIAL_LIST = generateTrialList(n)
        return TRIAL_LIST.map((condition) => {
            return {
                cue: condition[0],
                probe: condition[1],
            }
        })
    }
    
    function answeredLastTrial() {
        const LAST_DATA = jsPsych.data.get().last().values()[0]
        return LAST_DATA.rt != null
    }

    function answeredLastTrialCorrect() {
        return false
    }

    function getDelayTrial(delayTime) {
        return {
            type: "html-keyboard-response",
            stimulus: "",
            choices: jsPsych.NO_KEYS,
            trial_duration: delayTime,
        }
    }

    

    const INSTRUCTIONS = {
        type: "instructions",
        pages: [
            "Instruktionen...",
            "Mit den Tasten <strong>f / j</strong> soll zwischen <strong>Target / Non-Target</strong> unterschieden werden"
        ],
        show_clickable_nav: true,
    }


    const CUE_PRESENTATION = {
        type: "html-keyboard-response",
        stimulus: () => {
            return `<span style="font-size:${CUE_PROBE_FONTSIZE}">${jsPsych.timelineVariable("cue", true)}</span>`
        },
        trial_duration: STIMULUS_PRESENTATION_TIME,
        choices: jsPsych.NO_KEYS,
    }


    const PROBE_PRESENTATION = {
        type: "html-keyboard-response",
        stimulus: () => {
            return `<span style="font-size:${CUE_PROBE_FONTSIZE}">${jsPsych.timelineVariable("probe", true)}</span>`
        },
        trial_duration: MAX_ANSWER_TIME, 
        choices: [TARGET_KEY, NON_TARGET_KEY],
    }


    const PENALITY = {
        type: "html-keyboard-response",
        stimulus: () => {
            return answeredLastTrial() ? "" : `<span style="font-size:${PENALITY_FONTSIZE}">TOO SLOW!</span>`
        },
        on_start: (data) => {
            const hasAnswered = answeredLastTrial()
            data.trial_duration = hasAnswered ? 10 : 2000
            if (hasAnswered) {
                changeBackgroundColor(VISUAL_FEEDBACK_COLOR)
            }
        },
        trial_duration: 1,
        choices: jsPsych.NO_KEYS,
        on_finish: () => {
            changeBackgroundColor(BACKGROUND_COLOR)
        }
    }

    // used for practicing
    const FEEDBACK = {
        type: "html-keyboard-response",
        stimulus: () => {
            if (answeredLastTrial()) {
                return `<span style="font-size:${PENALITY_FONTSIZE}">TOO SLOW!</span>`
            } else if (answeredLastTrialCorrect()) {
                return "RICHTIG"
            } else {
                return "FALSCH"
            }
        },
        trial_duration: 1000,
        choices: jsPsych.NO_KEYS,
    }


    const END = {
        type: "html-keyboard-response",
        stimulus: "Die Demo ist zu Ende :)",
    }

    
    const EXP_TRIALS = {
        timeline: [CUE_PRESENTATION, getDelayTrial(DELAY), PROBE_PRESENTATION, PENALITY, getDelayTrial(INTERTRIAL_DELAY)],
        timeline_variables: generateTimelineVariables(AMOUNT_TRIALS),
    }

    jsPsych.init({
        timeline: [INSTRUCTIONS, EXP_TRIALS, END],
    })
</script>
</html>